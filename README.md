# Core Dashboard

### Краткое описание 
Web-приложение для анализа и визуализации образовательных результатов студентов, изучающих дисциплины Core в ТюмГУ.

### Стек технологий

`ASP.NET Core 8 Mvc`, `PostgreSQL 16.0`, `Grafana Enterprise 11.0.0`, `Docker`, `PgAdmin (опционально)`
Библиотеки: `Entity Framework Core 8` (8.0.3), `Npgsql` (8.0.3)
Система также тестировалась с `Grafana OSS 11.0.0`
Используется библиотека `select2` для функционального выпадающего списка на главной странице

## Развёртывание

### Первый способ: Docker (оркестрация docker-compose)

1. Установите Docker Desktop на сервер (убедитесь, что на сервере включена `"Платформа виртуальной машины"`)
2. Клонируйте содержимое ветки docker_launch на сервер
3. В папку CoreDashboard клонируйте содержимое ветки main
4. В папку CoreDashboard вставьте прилагаемый файл `appsettings.json`
5. Запустите Docker Engine (любым способом, можно просто запустить Docker Desktop)
6. В корневой папке проекта (docker_launch) откройте консоль и введите следующую команду:
    ```sh
    docker-compose up --build
    ```
7. Ожидайте скачивания, сборки, запуска и установки контейнеров.
8. Готово
    Доступ к сервисам по портам (до двоеточия - на сервере, после двоеточия - в контейнере): 
    - Веб-приложение `5000:8080`
    - PostgreSQL `54321:5432`
    - Grafana `3001:3000`
    - PgAdmin `5050:80`

### Второй способ: без использования Docker
1. Скачайте и установите образы `PostgreSQL 16.0`, `Grafana 11.0.0`, `ASP.NET Core 8`, `.NET SDK 8`
2. Клонируйте из репозитория ветку main
3. Добавьте из Яндекс.Диск прилагаемый файл `appsettings.json` в корневую папку проекта
    Его содержимое выглядит подобным образом:
    ```json
    {
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Microsoft.AspNetCore": "Warning"
        }
      },
      "AllowedHosts": "*",
      "ConnectionStrings": {
        "CoreDashboardDatabase": "Host=localhost; Port=postgres_port; Database=db_name; Username=user_name; Password=user_password"
      }
    }
    ```
4. В файле разкомментируйте 11 строку и закомментируйте 14
5. Замените порт 3001 на 3000 в файле Views/Home/Index.cshtml
6. PostgreSQL:
    - Создайте базу данных с названием `core_dashboard`
    - Используя утилиту `pg_restore` в корневой папке СУБД для загрузки дампа, выполните следующую команду:
        ```sh
        pg_restore -U postgres -d core_dashboard -v "db_init/core_dashboard.sql"
        ```
        где последнаяя строка представляет собой путь к дампу (находится в ветке dock)
    - (альтернативный способ) Применить миграцию Init (в ней заложены описания сущностей и их атрибутов, начальные данные и представления) через пакетный менеджер Visual Studio

7. Grafana:
    - Создайте источник данных для загрузки дашбордов с типом PostgreSQL (без использования SSL)
    - Из папки provisioning/dashboards загрузите все дашборды в формате json в систему
8. Соберите проект в ветке main и запустите
9. Готово

#### Для "боевого" запуска крайне рекомендуется удалить базовую учётную запись администратора и сменить пароли к БД

## Описание сервисов

В веб-приложении создано 4 контроллера: 
- HomeController (основная страница и загрузка данных);
- UserController (для выполнения CRUD-операций с пользователями);
- UploadedDbController (для выполнения просмотра, редактирования и удаления загруженных баз данных);
- AuthController (для обработки авторизации).

В приложении используется система авторизации на основе Cookies (использованы классы Claim, ClaimsIdentity, ClaimsPrincipal для хранения данных).

Загрузка данных проходит следующим образом (основным классом является `DataUploader`):
- Проверяется название базы данных на уникальность
- Проверяется существование необходимых данных для загрузки результатов и записей (студентов, пар, преподавателей, учебных групп) (класс `DataExistanceVerifier`)
- Загружаются результаты с привязкой к загружаемой базе данных (метод `VerifyResults` в классе `DataExistanceVerifier`)
- Загружаются записи

В БД содержатся 12 сущностей, ER-диаграмму можно рассмотреть в файле `erd.png`.

Grafana никак не взаимодействует с веб-приложением, все необходимые запросы содержатся в структуре дашбордов и выполняются непосредственно к базе данных.

## License

MIT
